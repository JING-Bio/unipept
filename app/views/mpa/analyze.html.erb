<% content_for :javascripts do %>
  <%= javascript_pack_tag 'd3' %>
  <%= javascript_pack_tag 'mpa' %>
<% end %>

<div class='card'>
  <div class='card-title card-title-colored'>
    <h2 class='card-title-text'>Metaproteomics Analysis<%= " â€” #{@name}" if @name.present? %></h2>
  </div>
  <div id="progress-analysis" class="unipept-progress unipept-progress-indeterminate">
    <div class="progressbar bar bar1" style="width: 0%;"></div>
    <div class="bufferbar bar bar2" style="width: 100%;"></div>
    <div class="auxbar bar bar3" style="width: 0%;"></div>
  </div>
  <div class='card-supporting-text'>
    <div class='col-md-6'>
        Please wait while we are preparing your data...
    </div>
    <div class='col-md-6'>
      <div id="search_elements" class='form-group'>
        <%= text_area_tag(:qs, nil, rows: 5, spellcheck: false, class: "form-control", disabled: true) %>
      </div>
      <div class="checkbox">
        <%= label_tag(:il, check_box_tag(:il, 1, false) + " Equate I and L", title: "Equate isoleucine (I) and leucine (L) when matching peptides to UniProt entries.", class: 'js-has-hover-tooltip') %>
      </div>
      <div class="checkbox">
        <%= label_tag(:dupes, check_box_tag(:dupes, 1, false) + " Filter duplicate peptides", title: "Remove duplicate peptides from the input before searching.", class:'js-has-hover-tooltip') %>
      </div>
      <div class="checkbox">
        <%= label_tag(:missed, check_box_tag(:missed, 1, false) + " Advanced missed cleavage handling", title: "Recombine subpeptides of miscleavages. Enabling this has a serious performance impact!", class: 'js-has-hover-tooltip') %>
      </div>
      <div id="search_button" class='search-buttons-centered'>
        <%= button_tag(raw("<span class='glyphicon glyphicon-refresh spin'></span> Update"), :class => "btn btn-primary btn-animate", :id =>"mpa-update-settings", :"data-loading-text" => "Loading...") %>
      </div>
    </div>
  </div>
</div>


<div class='card card-nav'>
  <div class='card-title card-title-colored'>
    <ul class="nav nav-tabs visualisations" id="viz-tabs">
      <li><a href="#sunburstWrapper" data-toggle="tab">Sunburst</a></li>
      <li><a href="#d3TreeMapWrapper" data-toggle="tab">Treemap</a></li>
      <li class="active"><a href="#d3TreeViewWrapper" data-toggle="tab">Treeview</a></li>
    </ul>
  </div>
  <div class='card-supporting-text multi-results'>
    <div class="full-screen-container tab-content multi-search not-full-screen">
      <div id="buttons" class='buttons-single'></div>
      <div class="full-screen-bar">
        <div class="logo"><img src="<%= asset_path('trans_logo.png') %>" alt="logo" width="40" height="40"></div>
        <nav class="fullScreenNav">
          <ul class="visualisations">
            <li class="active"><a href="#sunburstWrapper" data-toggle="tab">Sunburst</a></li>
            <li><a href="#d3TreeMapWrapper" data-toggle="tab">Treemap</a></li>
            <li><a href="#d3TreeViewWrapper" data-toggle="tab">Treeview</a></li>
          </ul>
        </nav>
        <div class="fullScreenActions">
          <a title="Reset the visualisation" class="btn-animate reset"><span class="glyphicon glyphicon-repeat spin"></span></a>
          <a title="Download the current view as an svg or png image" class="btn-animate download"><span class="glyphicon glyphicon-download down"></span></a>
          <a title="Exit full screen mode" class="btn-animate exit"><span class="glyphicon glyphicon-resize-small shrink"></span></a>
        </div>
      </div>
      <div class="tab-pane" id="sunburstWrapper">
        <h2 class="ghead">
          <span class="dir">
            <a class="btn btn-xs btn-default btn-animate" id="sunburst-reset" title="reset visualisation"><span class="glyphicon glyphicon-repeat spin"></span></a>
          </span>
          <span class="dir">
            <div class="btn-group" id="colorswap">
              <a class="btn btn-xs btn-default dropdown-toggle" data-toggle="dropdown" id="colorswap-button"><span class="glyphicon glyphicon-cog"></span></a>
              <ul class="dropdown-menu dropdown-menu-right dropdown-menu-form">
                <li title="Enabling this will assign fixed colors to taxa making it easier to compare samples.">
                  <div class="checkbox"><label class="checkbox"><input type="checkbox" id="colorswap-checkbox">Use fixed colors</label></div>
                </li>
              </ul>
            </div>
          </span>
          <span class="dir text">Click a slice to zoom in and the center node to zoom out</span>
        </h2>
        <div id="sunburst">
          <div id="sunburstPanel">&nbsp;</div>
        </div>
      </div>
      <div class="tab-pane" id="d3TreeMapWrapper">
        <h2 class="ghead">
          <span class="dir">
            <a class="btn btn-xs btn-default btn-animate" id="treemap-reset" title="reset visualisation"><span class="glyphicon glyphicon-repeat spin"></span></a>
          </span>
          <span class="dir text">Click a square to zoom in and right click to zoom out</span>
        </h2>
        <div id="d3TreeMap"></div>
      </div>
      <div class="tab-pane active" id="d3TreeViewWrapper">
        <h2 class="ghead">
          <span class="dir">
            <a class="btn btn-xs btn-default btn-animate" id="treeview-reset" title="reset visualisation"><span class="glyphicon glyphicon-repeat spin"></span></a>
          </span>
          <span class="dir text">Scroll to zoom, drag to pan, click a node to expand, right click a node to set as root</span>
        </h2>
        <div id="mpa-treeview"></div>
      </div>
    </div>
  </div>
</div>

<script type="text/javascript">
  var peptides = <%= raw(@peptides) %>;
  var il = <%= @il %>;
  var dupes = <%= @dupes %>;
  var missed = <%= @missed %>;

  $(function () {
      new MPA(peptides, il, dupes, missed);
  });
</script>
