
# Unipept Metagenomics Analysis Pipeline

The Unipept Metagenomics Analysis Pipeline (UMGAP) is a tool for mapping (short) metagenomics reads to taxa,
rivalling state of the art alternatives such as [Kraken][kraken] with the additional benefit of species level identification.
UMGAP achieves this by transforming the mapping task into a metaproteomics problem
by using various alternative gene predictors on the metagenomics reads
and processing the resulting data with the existing Unipept Metaproteomics Analysis Pipeline.
Each step in UMGAP is highly configurable.

## Preprocessing

Throughout this overview of UMGAP, all steps will have examples to demonstrate the exact usage.
For this, we have sampled 100 paired-end DNA reads from a dataset generated by [Lindgreen et al.][metabenchmark] for their metabenchmark.
As this dataset contains paired-end reads in FASTQ format, and UMGAP operates on FASTA data,
we perform a first preprocessing step to convert the FASTQ into FASTA files:

    umgap fastq2fasta A1.fq A2.fq | sed '/^>/s_/[12]$__' > preprocessed.fa

This command will interleave the given FASTQ files and output a FASTA stream, in which the paired-ends alternate each other.
We use a `sed` substitution to remove the "/1" or "/2" indicating the end, as we will pool the ends later on anyway.

## Gene prediction

To convert the metagenomics reads into a metaproteomics problem,
we have to perform some kind of gene prediction.
While any gene prediction tool can be used, UMGAP was tested with [FragGeneScan][fgs] and FragGeneScan++,
our in-house improved version of [FragGeneScanPlus][fgsp], a predictor using on Hiddem Markov Models.
On the other hand you can choose not to bother with prediction and just translate all six reading frames completely with a builtin tool.

This step in the pipeline limits our tool to the coding regions of the given DNA reads.
This caps the sensitivity of our predictions, as we can offer no prediction for a read from a non-coding region.
On the other hand, coding regions are less prone to mutation and the mutations that do occur often do not change the resulting amino acid.

For more options on the FragGeneScan and FragGeneScan++ commands, read their respective documentation.
Here, it suffices to say that the commands below will write the predicted genes in FASTA format to a file called `predicted-genes.faa`.
For FragGeneScan:

    FGS -s preprocessed.fa -o predicted-genes -w0 -t illumina_10 -p 16 > /dev/null
    rm predicted-genes.fnn predicted-genes.out # we don't use these files

For FragGeneScan++:

    FGSpp -s stdin -o stdout -w 0 -r train -t illumina_10 -p 16 -m 3000 < preprocessed.fa > predicted-genes.faa

With our alternative six-frame translation option, we choose to translate all (`-a`) frames using the standard translation table.

    umgap translate -a < preprocessed.fa > predicted-genes.faa

## Taxonomic Classification

UMGAP uses exact substring matching to identify reads.
The next step of the pipeline fragments each amino acid sequence into 9-mers, all of its substrings of length 9,
and looks them up in our index.
This index maps each 9-mer encountered in the UniProt's [protein knowledgebase][uniprot] to the lowest common ancestor (LCA) of all the organisms it occured in.
The LCA of a set of taxa is equal to the taxon of the most specific rank in the [NCBI taxonomy][ncbi] that is either a descendant or an ancestor of all taxa in that set.

    umgap prot2kmer2lca -k9 9-mer.index < predicted-genes.faa > found-kmers.fa

This command will look up each 9-mer in the input data and output the associated taxon if any is found.
With the `-o` or `--one-on-one` flag the unrecognized 9-mers will be included as a "0" taxon,
the use of which will be clarified in the next step.

## (Optional) Filter by Seed-Extend

Especially when running the pipeline with all six frames, a lot of the translations are invalid.
The Seed-Extend step in the pipeline filters out most random hits by selecting only 9-mer hits which are spatially close to other hits.

    umgap seedextend -g2 -s4 taxons.tsv < found-kmers.fa | grep -v '^0$' > selected-seeds.fa

This algorithm requires spatial information which is provided by supplying the `-o` flag to the previous command. The `taxons.tsv` is a file describing the NCBI taxonomic tree. The `grep` command filters out remaining unknown identifications.

## Aggregation

At this step of the pipeline, we have a list of taxon identifiers per protein read,
one protein read per reading frame and two paired-ends per metagenomics read.
To get a single taxon identification per read, we need to aggregate this list.
UMGAP offers 3 alternative aggregation strategies with varying speciality:

* Unipept's lowest common ancestor strategy (LCA\*),
  where the consensus taxon is, as before, the taxon of most specific rank
  which is either descendant or ancestor of every given taxon;
* Kraken's maximum root-to-leaf path (MRTL),
  where the consensus taxon is the taxon in the given list
  which has the most ancestors in the given list;
* A newly developed hybrid strategy,
  which combines LCA\* and MRTL based on a given scaling factor.
  The hybrid method aims to ignore some outliers without compromising generality.

Before this aggregation, we combine the results of each reading frame and paired-end with `uniq`.

    umgap uniq < found-kmers.fa | umgap taxa2agg -m tree -a hybrid -f 0.75 taxons.tsv > classification.fa

Finally, the whole sample is summarized using e.g. a frequency table,
showing the number of reads mapping to each taxon,
or one of the many visualizations Unipept offers.

    grep -v '^>' | umgap report -r species taxons.tsv

The `grep` command will drop the FASTA headers,
allowing the `report` command to snap each taxon to either a species or "unknown"
and report the frequency table of the results.

## References

[kraken]: Wood DE, Salzberg SL: Kraken: ultrafast metagenomic sequence classification using exact alignments. Genome Biology 2014, 15:R46.
[metabenchmark]: Lindgreen, Adair & Gardner (2016) An evaluation of the accuracy and speed of metagenome analysis tools. Scientific Reports. 6, 19233. (http://www.ucbioinformatics.org/metabenchmark.html)
[fgs]: Mina Rho, Haixu Tang, and Yuzhen Ye. FragGeneScan: Predicting Genes in Short and Error-prone Reads. Nucl. Acids Res., 2010 doi: 10.1093/nar/gkq747
[fsgp]: Dongjae Kim, Aria S. Hahn, Shang-Ju Wu, Niels W. Hanson, Kishori M. Konwar, Steven J. Hallam. FragGeneScan+: high-throughput short-read gene prediction, Proceedings of the 2015 IEEE Conference on Computational Intelligence in Bioinformatics and Computational Biology (CIBCB 2015), Niagara Falls, Canada, August 12-15, 2015. doi:10.1109/cibcb.2015.7300341.
[uniprot]: The UniProt Consortium. 2015. UniProt: A hub for protein information. Nucleic Acids Research 43 (D1): D204–D212. doi:10.1093/nar/gku989.
[ncbi]: Scott Federhen. The ncbi taxonomy database. Nucleic acids research, 40(D1):D136–D143, 2012.
